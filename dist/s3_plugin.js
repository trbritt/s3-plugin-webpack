!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash"),require("path"),require("aws-sdk"),require("cdnizer"),require("fs"),require("http"),require("https"),require("progress"),require("recursive-readdir"),require("s3")):"function"==typeof define&&define.amd?define(["lodash","path","aws-sdk","cdnizer","fs","http","https","progress","recursive-readdir","s3"],t):"object"==typeof exports?exports["webpack-s3-plugin"]=t(require("lodash"),require("path"),require("aws-sdk"),require("cdnizer"),require("fs"),require("http"),require("https"),require("progress"),require("recursive-readdir"),require("s3")):e["webpack-s3-plugin"]=t(e.lodash,e.path,e["aws-sdk"],e.cdnizer,e.fs,e.http,e.https,e.progress,e["recursive-readdir"],e.s3)}(this,function(e,t,n,r,i,o,s,u,a,l){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var s,u=e[Symbol.iterator]();!(r=(s=u.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(a){i=!0,o=a}finally{try{!r&&u["return"]&&u["return"]()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(7),a=r(u),l=n(8),c=r(l),d=n(11),f=r(d),p=n(6),h=r(p),v=n(2),P=r(v),g=n(9),m=r(g),y=n(5),S=r(y),O=n(1),_=r(O),T=n(4),F=r(T),A=n(3);a["default"].globalAgent.maxSockets=c["default"].globalAgent.maxSockets=50;var E=function(e,t){e.errors.push(new Error(t))};e.exports=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];i(this,e);var n=t.include,r=t.exclude,o=t.basePath,s=t.directory,u=t.htmlFiles,a=t.basePathTransform,l=void 0===a?A.DEFAULT_TRANSFORM:a,c=t.s3Options,d=void 0===c?{}:c,f=t.cdnizerOptions,p=void 0===f?{}:f,h=t.s3UploadOptions,v=void 0===h?{}:h,P=t.cloudfrontInvalidateOptions,g=void 0===P?{}:P;this.uploadOptions=v,this.cloudfrontInvalidateOptions=g,this.isConnected=!1,this.cdnizerOptions=p,this.urlMappings=[],this.uploadTotal=0,this.uploadProgress=0,this.basePathTransform=l,o=o?(0,A.addTrailingS3Sep)(o):"",this.options={directory:s,include:n,exclude:r,basePath:o,htmlFiles:"string"==typeof u?[u]:u},this.clientConfig={maxAsyncS3:50,s3Options:_["default"].merge({},A.DEFAULT_S3_OPTIONS,d)},this.noCdnizer=!Object.keys(this.cdnizerOptions).length,this.noCdnizer||this.cdnizerOptions.files||(this.cdnizerOptions.files=[])}return s(e,[{key:"apply",value:function(e){var t=this;this.connect();var n=!!this.options.directory,r=null!==this.client.s3.config.credentials,i=_["default"].every(A.REQUIRED_S3_UP_OPTS,function(e){return t.uploadOptions[e]});this.options.directory=this.options.directory||e.options.output.path||e.options.output.context||".",e.plugin("after-emit",function(e,o){var s;if(r||(s="S3Plugin: Must provide "+A.REQUIRED_S3_OPTS.join(", ")),i||(s="S3Plugin-RequiredS3UploadOpts: "+A.REQUIRED_S3_UP_OPTS.join(", ")),s&&(E(e,s),o()),n){var u=(0,A.addSeperatorToPath)(t.options.directory);t.getAllFilesRecursive(u).then(function(e){return t.handleFiles(e,o)}).then(function(){return o()})["catch"](function(n){return t.handleErrors(n,e,o)})}else t.getAssetFiles(e).then(function(e){return t.handleFiles(e)}).then(function(){return o()})["catch"](function(n){return t.handleErrors(n,e,o)})})}},{key:"handleFiles",value:function(e){var t=this;return this.changeUrls(e).then(function(e){return t.filterAllowedFiles(e)}).then(function(e){return t.uploadFiles(e)}).then(function(){return t.invalidateCloudfront()})}},{key:"handleErrors",value:function(e,t,n){E(t,"S3Plugin: "+e),t.errors.length>0&&(console.log(t.errors),process.exit(1)),n()}},{key:"getAllFilesRecursive",value:function(e){return(0,A.getDirectoryFilesRecursive)(e)}},{key:"addPathToFiles",value:function(e,t){return e.map(function(e){return{name:e,path:P["default"].resolve(t,e)}})}},{key:"getFileName",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return _["default"].includes(e,A.PATH_SEP)?e.substring(_["default"].lastIndexOf(e,A.PATH_SEP)+1):e}},{key:"getAssetFiles",value:function(e){var t=e.assets,n=_["default"].map(t,function(e,t){return{name:t,path:e.existsAt}});return Promise.resolve(n)}},{key:"cdnizeHtml",value:function(e){var t=this;return new Promise(function(n,r){h["default"].readFile(e.path,function(i,o){return i?r(i):void h["default"].writeFile(e.path,t.cdnizer(o.toString()),function(t){return t?r(t):void n(e)})})})}},{key:"changeUrls",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?[]:arguments[0];if(this.noCdnizer)return Promise.resolve(t);var n,r=this.options,i=r.directory,s=r.htmlFiles,u=void 0===s?[]:s;n=u.length?this.addPathToFiles(u,i).concat(t):t,this.cdnizerOptions.files=n.map(function(e){var t=e.name;return"*"+t+"*"}),this.cdnizer=(0,S["default"])(this.cdnizerOptions);var a=(0,_["default"])(n).uniq("name").partition(function(e){return/\.(html)/.test(e.name)}).value(),l=o(a,2),c=l[0],d=l[1];return Promise.all(c.map(function(t){return e.cdnizeHtml(t)}).concat(d))}},{key:"filterAllowedFiles",value:function(e){var t=this;return e.reduce(function(e,n){return t.isIncludeAndNotExclude(n.name)&&!t.isIgnoredFile(n.name)&&e.push(n),e},[])}},{key:"isIgnoredFile",value:function(e){return _["default"].some(A.UPLOAD_IGNORES,function(t){return new RegExp(t).test(e)})}},{key:"isIncludeAndNotExclude",value:function(e){var t,n,r=this.options,i=r.include,o=r.exclude;return n=!i||i.test(e),t=!!o&&o.test(e),n&&!t}},{key:"connect",value:function(){this.isConnected||(this.client=f["default"].createClient(this.clientConfig),this.isConnected=!0)}},{key:"transformBasePath",value:function(){var e=this;return Promise.resolve(this.basePathTransform(this.options.basePath)).then(A.addTrailingS3Sep).then(function(t){return e.options.basePath=t})}},{key:"setupProgressBar",value:function(e){var t=Array(e.length),n=Array(e.length),r=function(){return _["default"].sum(t)/_["default"].sum(n)},i=0,o=function(e){return _["default"].reduce(e,function(e,t){return e+=_["default"].isUndefined(t)?1:0},0)},s=new m["default"]("Uploading [:bar] :percent :etas",{complete:">",incomplete:"âˆ†",total:100});e.forEach(function(e,u){var a=e.upload;a.on("progress",function(){var e,a;n[u]=this.progressTotal,t[u]=this.progressAmount,e=o(n)/10,a=r()-e,a!==i&&(s.update(a),i=a)})})}},{key:"uploadFiles",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?[]:arguments[0];return this.transformBasePath().then(function(){var n=t.map(function(t){return e.uploadFile(t.name,t.path)});return e.setupProgressBar(n),Promise.all(n.map(function(e){var t=e.promise;return t}))})}},{key:"uploadFile",value:function(e,t){var n,r=this.options.basePath+e,i=_["default"].mapValues(this.uploadOptions,function(n){return _["default"].isFunction(n)?n(e,t):n});/\.ico/.test(e)&&"gzip"===i.ContentEncoding&&delete i.ContentEncoding,n=this.client.uploadFile({localFile:t,s3Params:_["default"].merge({Key:r},A.DEFAULT_UPLOAD_OPTIONS,i)}),this.noCdnizer||this.cdnizerOptions.files.push("*"+e+"*");var o=new Promise(function(e,r){n.on("error",r),n.on("end",function(){return e(t)})});return{upload:n,promise:o}}},{key:"invalidateCloudfront",value:function(){var e=this.clientConfig,t=this.cloudfrontInvalidateOptions;return new Promise(function(n,r){if(!t.DistributionId)return n(null);var i=new F["default"].CloudFront;i.config.update({accessKeyId:e.s3Options.accessKeyId,secretAccessKey:e.s3Options.secretAccessKey}),i.createInvalidation({DistributionId:t.DistributionId,InvalidationBatch:{CallerReference:Date.now().toString(),Paths:{Quantity:t.Items.length,Items:t.Items}}},function(e,t){return e?r(e):n(t.Id)})})}}]),e}()},function(t,n){t.exports=e},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.getDirectoryFilesRecursive=t.translatePathFromFiles=t.addSeperatorToPath=t.addTrailingS3Sep=t.DEFAULT_TRANSFORM=t.S3_PATH_SEP=t.PATH_SEP=t.REQUIRED_S3_UP_OPTS=t.REQUIRED_S3_OPTS=t.DEFAULT_S3_OPTIONS=t.DEFAULT_UPLOAD_OPTIONS=t.UPLOAD_IGNORES=void 0;var i=n(1),o=r(i),s=n(2),u=r(s),a=n(10),l=r(a),c=(t.UPLOAD_IGNORES=[".DS_Store"],t.DEFAULT_UPLOAD_OPTIONS={ACL:"public-read"},t.DEFAULT_S3_OPTIONS={region:"us-west-2"},t.REQUIRED_S3_OPTS=["accessKeyId","secretAccessKey"],t.REQUIRED_S3_UP_OPTS=["Bucket"],t.PATH_SEP=u["default"].sep),d=t.S3_PATH_SEP="/",f=(t.DEFAULT_TRANSFORM=function(e){return Promise.resolve(e)},t.addTrailingS3Sep=function(e){return e?e.replace(/\/?(\?|#|$)/,"/$1"):e},t.addSeperatorToPath=function(e){return e?o["default"].endsWith(e,c)?e:e+c:e},t.translatePathFromFiles=function(e){return function(t){return o["default"].map(t,function(t){return{path:t,name:t.replace(e,"").split(c).join(d)}})}});t.getDirectoryFilesRecursive=function(e){var t=arguments.length<=1||void 0===arguments[1]?[]:arguments[1];return new Promise(function(n,r){(0,l["default"])(e,t,function(e,t){return e?r(e):n(t)})}).then(f(e))}},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("https")},function(e,t){e.exports=u},function(e,t){e.exports=a},function(e,t){e.exports=l}])});